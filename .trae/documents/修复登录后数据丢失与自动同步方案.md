## 问题原因分析
- 登出时清空状态与本地标签：`App.tsx:485-494` 会 `setEvents([])`、`setTags(INITIAL_TAGS)` 并删除 `localStorage('calendar_tags')`，导致未同步的本地标签直接丢失。
- 事件仅云端保存：创建/更新/删除事件都依赖云端接口（`App.tsx:99-104`、`App.tsx:134-146`，`utils/eventService.ts:27-76`），登出后内存清空，需登录后重新拉取。
- 登录后数据加载逻辑：`App.tsx:258-273` 登录时仅当云端标签存在才覆盖本地标签，否则保留默认 `INITIAL_TAGS`，且可见标签 `visibleTags` 不持久化。
- 本地持久化不按用户隔离：标签持久化使用固定键 `calendar_tags`（`App.tsx:25-43`），登出后直接删除，无法实现自动合并与跨登录保留。
- 后端配置或迁移缺失会导致云端为空：Schema 见 `supabase/migrations/*.sql`，若未正确应用或 RLS 未配置，云端读写失败，登录后拉取为空。

## 解决方案设计
- 保留本地数据与按用户隔离：不在登出时删除本地标签；本地持久化键改为 `calendar_tags_{userId||guest}`，同时持久化 `visible_tags_{userId||guest}`。
- 登录时执行双向同步：
  - 先拉取云端 `tags` 与 `events`；读取本地缓存。
  - 将本地未在云端的标签批量上报（按 `id` 去重）。
  - 合并后更新 `tags`、`visibleTags`，并回写本地缓存。
- 增强错误提示与日志：对 `createEvents`/`createTag` 返回为空或报错的情况给出 UI 提示，避免误以为写入成功。
- 后端校验与准备：确保 `VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY` 正确；执行 `001_events.sql`、`002_add_category_to_events.sql`、`002_tags.sql`；验证 RLS 与匿名键权限。

## 具体改动清单
- 修改登出流程（`App.tsx:485-494`）：
  - 移除 `localStorage.removeItem('calendar_tags')`；仅重置内存状态，不清理本地缓存。
- 登录后同步流程（`App.tsx:258-273` 扩展）：
  - 读取本地 `calendar_tags_{userId}` 与 `visible_tags_{userId}`。
  - 合并云端与本地标签；新增 `bulkUpsertTags(userId, tags)`（若服务端不支持批量则循环调用 `createTag`）。
  - `visibleTags` 设为合并后的标签集 + 事件中的 `category` 去重集合。
  - 将合并结果写回本地，以用户维度持久化。
- 本地持久化策略（`App.tsx:41-43` 等）：
  - 键名改为用户维度：`calendar_tags_{userId||'guest'}`。
  - 新增 `visible_tags_{userId||'guest'}` 同步 effect。
- 同步辅助（新增或扩展 `utils/syncService.ts`）：
  - 提供 `syncTags(userId, localTags, cloudTags)`；必要时增加 `syncEvents`（当前事件仅云端，通常无需本地持久化）。
- 失败提示：在 `handleAddEvent`、`handleAddTag` 等位置，若返回为空或异常，弹出“保存失败，请重试”，并写入控制台日志以便排查。

## 验证方案
- 后端迁移与权限验证：在 Supabase 控制台执行 migrations 并检查 RLS 策略与匿名键权限。
- 手动流程测试：
  - 登录→创建标签与时间段→登出→重新登录→数据仍在且与云端一致。
  - 本地存在未同步标签→登录后自动上云并合并；刷新后仍存在。
  - 删除标签→对应事件云端删除，重新登录仍一致。
- 可见性持久化：切换 `visibleTags`，刷新与重登后仍保持。

## 风险与回滚
- 跨账号数据混淆风险：通过用户维度键名避免；如出现异常，可临时回退为仅云端覆盖策略。
- 合并重复风险：以标签 `id` 为唯一键，必要时在创建时对 `label` 去重并提示。

## 交付与后续
- 先实施前端改动与登录同步逻辑；
- 同步检查后端配置；
- 增加错误提示与日志；
- 完成后提供测试结果与变更文件列表。