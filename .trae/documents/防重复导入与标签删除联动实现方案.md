## 目标
- 导入 Apple Calendar 的 .ics 文件时对选定标签去重：同一天、同时间段、同标题、同标签的事件只新增未存在的部分。
- 删除标签时联动删除该标签下的所有事件（本地与云端）。

## 实施方案
- 去重策略（前端）：在 `App.tsx` 的 `handleImportEvents` 中先构造 `newEvents`，再与现有 `events` 进行对比，过滤掉重复项后再保存。
- 删除标签联动：在 `handleDeleteTag` 中，除移除 `tags` 外，同时删除 `events` 中 `category === id` 的事件；若处于登录态，则调用服务层进行云端批量删除。

## 去重判定规则
- 事件被视为重复，当以下字段全部相同：
  - `category`（所选标签）
  - `date`（同一自然日，比较到日）
  - `startTime` 与 `endTime`
  - `title`
- 注：若你希望忽略标题，仅按时间段与标签去重，也可调整为不比较 `title`。
- 可选增强：解析 `.ics` 时提取 `UID` 字段用于高精度去重（现有 `parseICS` 未解析 `UID`，可后续补充）。

## 代码改动点
- `App.tsx`
  - 修改 `handleImportEvents`（约 `App.tsx:296-328`）：
    - 在生成 `newEvents` 后，定义 `isDuplicate(a,b)` 比较同标签同日同时间（可含 `title`）。
    - 用 `events` 里同标签的现有事件作基准过滤出 `uniqueEvents`。
    - 登录态：将 `uniqueEvents` 映射为持久化条目后调用 `createEvents`；未登录：直接合并到本地状态。
  - 修改 `handleDeleteTag`（`App.tsx:162-164`）：
    - 先更新 `tags`。
    - 删除本地 `events` 中 `category === id` 的事件；同步更新 `visibleTags` 去除该标签。
    - 若登录态，调用服务层批量删除该标签下事件（见下）。
- `utils/eventService.ts`
  - 新增 `deleteEventsByCategory(userId: string, categoryId: string): Promise<boolean>`：执行 `from('events').delete().eq('user_id', userId).eq('category', categoryId)`，返回成功与否。

## 数据库可选增强（非必须）
- 为防边界情况（并发或跨设备重复），建议在 `events` 表添加唯一约束：`unique(user_id, title, start_time, end_time, category)`。
- 注意：当前迁移文件 `supabase/migrations/001_events.sql` 未包含 `category` 列；若采用唯一约束，需要同步添加 `category` 字段与索引，并确保 RLS 策略不受影响。

## 验证用例
- 用同一 `.ics` 文件对同一标签连续导入两次：第二次不应新增重复事件，仅新增新的或变更后的时间段。
- 删除某标签：该标签下的事件在 UI 中消失；登录态下云端数据亦被批量删除；重新登录或刷新后不再出现。
- 跨天事件与一般事件均可正常处理；导入后若登录，依旧按拆分规则或原始时间入库与展示（取决于 `.ics` 事件是否跨天）。

## 兼容与安全
- 所有云端操作均在登录态下执行，遵循 Supabase RLS；未登录仅影响本地状态。
- 不改动现有登录/加载流程；失败时提供用户提示，不影响其他功能。