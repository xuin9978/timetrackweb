## 问题归因
- 事件（闹钟/日历/导入）在登录瞬间可能写入 `guest` 本地键，重登时仅读取用户键导致丢失。
- 标签删除未双向同步：登录合并逻辑只做“云端 ∪ 本地”的加法，未处理删除冲突，云端残留会把已删除标签带回。
- ics 导入在云端不可写时之前无本地回退，或类别/日期复原不稳定，导致重登过滤掉。
- 云端保存失败（RLS/环境变量/表结构）时，需要稳定的本地持久化与重登合并策略避免数据不可见。

## 解决方案
1. 统一事件恢复与迁移
- 登录后读取两套本地事件：`calendar_events_{userId}` 与 `calendar_events_guest`，标准化 `date` 为 `Date`，按 `isDup` 与云端去重。
- 合并顺序：`final = fetchedFromCloud + createdOnCloud + localMissing`。
- 将 `final` 写回用户键并清除 `guest` 键，完成一次性迁移。
- 已在代码中完成，但将增加日志与断言，确认每步成功。

2. 标签删除双向同步
- 新增本地“删除墓碑”键：`deleted_tags_{userId}`。
- 执行删除时：写入墓碑、尝试云端删除标签及其事件；本地立即过滤标签与事件。
- 登录合并时：先读取墓碑，再过滤掉云端返回中在墓碑列表内的标签，并执行云端二次删除（防止云端残留）；最后更新本地标签与 `visibleTags`。

3. 导入 .ics 的稳健持久化
- 已加云端失败的本地回退；再补充导入校验：确保每条导入事件都有 `date`/`startTime`/`endTime`/`category`，若 `category` 不匹配现有标签，则绑定到首个标签并提示。
- 导入后立即持久化到用户键（若 `currentUser` 初始中，则同时写入 `guest` 键作为冗余）；登录后统一迁移。

4. 可见性与过滤一致性
- 登录后基于最终事件集合补全 `visibleTags`，保证导入/闹钟生成的类别不被过滤掉。
- 增加可选“重建可见标签”操作按钮，用户一键修复可见性。

## 验证清单
- 闹钟创建 → 退出 → 重登：事件仍在；Supabase 可用时后台可见。
- 标签创建/删除 → 退出 → 重登：新增保留、删除不回滚；墓碑机制不再带回已删标签。
- .ics 导入 → 退出 → 重登：事件保留；云端可用时自动上报。
- 日历手动创建 → 退出 → 重登：事件保留；云端可用时自动上报。

## 代码改动范围
- `App.tsx`：登录合并（读取两键、迁移）、墓碑读取过滤、`visibleTags` 补全；导入/创建失败日志。
- `utils/syncService.ts`：新增 `syncDeletedTags`，执行云端二次删除并返回过滤后的集合。

## 风险与回滚
- 删除墓碑需谨慎：仅对用户主动删除的标签记录；提供清理墓碑的设置项。
- 保持去重规则稳定，避免重复事件；所有变更可逐步提交验证。

## 请求确认
- 我将按以上方案实现并验证，确保四类场景均可重登后显示或删除不回滚。确认后我开始动手。